From 4b00add26755c51b1dcbb5f52a55598d1c2367fe Mon Sep 17 00:00:00 2001
From: Erik Dannenberg <erik.dannenberg@xtrade-gmbh.de>
Date: Fri, 29 Apr 2022 20:21:28 +0200
Subject: [PATCH 1/3] Revert "user.eclass: Fixing user/group creation when
 using different ROOT"

This reverts commit 01eb3f7d7e1d897aefeab941326670e74512a0cb.
---
 eclass/user.eclass | 128 ++++++---------------------------------------
 1 file changed, 17 insertions(+), 111 deletions(-)

diff --git a/eclass/user.eclass b/eclass/user.eclass
index aab549d0c47..ff69be81c1e 100644
--- a/eclass/user.eclass
+++ b/eclass/user.eclass
@@ -117,9 +117,6 @@ enewuser() {
 	# options to pass to useradd
 	local opts=()
 
-	# handle for ROOT != /
-	[[ -n ${ROOT} ]] && opts+=( --prefix "${ROOT}" )
-
 	# handle uid
 	local euid=${1}; shift
 	if [[ -n ${euid} && ${euid} != -1 ]] ; then
@@ -210,24 +207,13 @@ enewuser() {
 		;;
 
 	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix option."
-			ewarn "Please use: \"useradd ${opts[@]} ${euser}\" in a chroot"
-		else
-			useradd "${opts[@]}" "${euser}" || die
-		fi
+		useradd "${opts[@]}" "${euser}" || die
 		;;
 
 	*-openbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "OpenBSD's usermod does not support --prefix option."
-			ewarn "Please use: \"useradd ${opts[@]} ${euser}\" in a chroot"
-		else
-			# all ops the same, except the -g vs -g/-G ...
-			useradd -u ${euid} -s "${eshell}" \
-				-d "${ehome}" -g "${egroups}" "${euser}" || die
-		fi
-
+		# all ops the same, except the -g vs -g/-G ...
+		useradd -u ${euid} -s "${eshell}" \
+			-d "${ehome}" -g "${egroups}" "${euser}" || die
 		;;
 
 	*)
@@ -238,10 +224,6 @@ enewuser() {
 	if [[ -n ${create_home} && ! -e ${ROOT}/${ehome} ]] ; then
 		elog " - Creating ${ehome} in ${ROOT}"
 		mkdir -p "${ROOT}/${ehome}"
-		# Use UID if we are in another ROOT than /
-		if [[ -n "${ROOT}" ]]; then
-			euser=$(egetent passwd ${euser} | cut -d: -f3)
-		fi
 		chown "${euser}" "${ROOT}/${ehome}"
 		chmod 755 "${ROOT}/${ehome}"
 	fi
@@ -304,10 +286,6 @@ enewgroup() {
 	fi
 	elog " - Groupid: ${egid}"
 
-	# handle different ROOT
-	local opts
-	[[ -n ${ROOT} ]] && opts=( --prefix "${ROOT}" )
-
 	# handle extra
 	if [[ $# -gt 0 ]] ; then
 		die "extra arguments no longer supported; please file a bug"
@@ -328,29 +306,24 @@ enewgroup() {
 	case ${CHOST} in
 	*-freebsd*|*-dragonfly*)
 		_enewgroup_next_gid
-		pw groupadd "${opts[@]}" "${egroup}" -g ${egid} || die
+		pw groupadd "${egroup}" -g ${egid} || die
 		;;
 
 	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix <dir> option."
-			ewarn "Please use: \"groupadd -g ${egid} ${opts[@]} ${egroup}\" in a chroot"
-		else
-			_enewgroup_next_gid
-			groupadd -g ${egid} "${opts[@]}" "${egroup}" || die
-		fi
+		_enewgroup_next_gid
+		groupadd -g ${egid} "${egroup}" || die
 		;;
 
 	*)
+		local opts
 		if [[ ${egid} == *[!0-9]* ]] ; then
 			# Non numeric; let groupadd figure out a GID for us
-			#
-			true # Do nothing but keep the previous comment.
+			opts=""
 		else
-			opts+=( -g ${egid} )
+			opts="-g ${egid}"
 		fi
 		# We specify -r so that we get a GID in the system range from login.defs
-		groupadd -r "${opts[@]}" "${egroup}" || die
+		groupadd -r ${opts} "${egroup}" || die
 		;;
 	esac
 }
@@ -380,10 +353,6 @@ esethome() {
 		return 1
 	fi
 
-	# Handle different ROOT
-	local opts
-	[[ -n ${ROOT} ]] && opts=( --prefix "${ROOT}" )
-
 	# handle homedir
 	local ehome=${1}; shift
 	if [[ -z ${ehome} ]] ; then
@@ -414,28 +383,15 @@ esethome() {
 	# update the home directory
 	case ${CHOST} in
 	*-freebsd*|*-dragonfly*)
-		pw usermod "${opts[@]}" "${euser}" -d "${ehome}" && return 0
+		pw usermod "${euser}" -d "${ehome}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update home"
 		eerror "There was an error when attempting to update the home directory for ${euser}"
 		eerror "Please update it manually on your system:"
 		eerror "\t pw usermod \"${euser}\" -d \"${ehome}\""
 		;;
 
-	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix <dir> option."
-			ewarn "Please use: \"usermod ${opts[@]} -d ${ehome} ${euser}\" in a chroot"
-		else
-			usermod "${opts[@]}" -d "${ehome}" "${euser}" && return 0
-			[[ $? == 8 ]] && eerror "${euser} is in use, cannot update home"
-			eerror "There was an error when attempting to update the home directory for ${euser}"
-			eerror "Please update it manually on your system (as root):"
-			eerror "\t usermod -d \"${ehome}\" \"${euser}\""
-		fi
-		;;
-
 	*)
-		usermod "${opts[@]}" -d "${ehome}" "${euser}" && return 0
+		usermod -d "${ehome}" "${euser}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update home"
 		eerror "There was an error when attempting to update the home directory for ${euser}"
 		eerror "Please update it manually on your system (as root):"
@@ -466,10 +422,6 @@ esetshell() {
 		return 1
 	fi
 
-	# Handle different ROOT
-	local opts
-	[[ -n ${ROOT} ]] && opts=( --prefix "${ROOT}" )
-
 	# handle shell
 	local eshell=${1}; shift
 	if [[ -z ${eshell} ]] ; then
@@ -492,28 +444,15 @@ esetshell() {
 	# update the shell
 	case ${CHOST} in
 	*-freebsd*|*-dragonfly*)
-		pw usermod "${opts[@]}" "${euser}" -s "${eshell}" && return 0
+		pw usermod "${euser}" -s "${eshell}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update shell"
 		eerror "There was an error when attempting to update the shell for ${euser}"
 		eerror "Please update it manually on your system:"
 		eerror "\t pw usermod \"${euser}\" -s \"${eshell}\""
 		;;
 
-	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix <dir> option."
-			ewarn "Please use: \"usermod ${opts[@]} -s ${eshell} ${euser}\" in a chroot"
-		else
-			usermod "${opts[@]}" -s "${eshell}" "${euser}" && return 0
-			[[ $? == 8 ]] && eerror "${euser} is in use, cannot update shell"
-			eerror "There was an error when attempting to update the shell for ${euser}"
-			eerror "Please update it manually on your system (as root):"
-			eerror "\t usermod -s \"${eshell}\" \"${euser}\""
-		fi
-		;;
-
 	*)
-		usermod "${opts[@]}" -s "${eshell}" "${euser}" && return 0
+		usermod -s "${eshell}" "${euser}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update shell"
 		eerror "There was an error when attempting to update the shell for ${euser}"
 		eerror "Please update it manually on your system (as root):"
@@ -543,10 +482,6 @@ esetcomment() {
 		return 1
 	fi
 
-	# Handle different ROOT
-	local opts
-	[[ -n ${ROOT} ]] && opts=( --prefix "${ROOT}" )
-
 	# handle comment
 	local ecomment=${1}; shift
 	if [[ -z ${ecomment} ]] ; then
@@ -565,28 +500,15 @@ esetcomment() {
 	# update the comment
 	case ${CHOST} in
 	*-freebsd*|*-dragonfly*)
-		pw usermod "${opts[@]}" "${euser}" -c "${ecomment}" && return 0
+		pw usermod "${euser}" -c "${ecomment}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update comment"
 		eerror "There was an error when attempting to update the comment for ${euser}"
 		eerror "Please update it manually on your system:"
 		eerror "\t pw usermod \"${euser}\" -c \"${ecomment}\""
 		;;
 
-	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix <dir> option."
-			ewarn "Please use: \"usermod ${opts[@]} -c ${ecomment} ${euser}\" in a chroot"
-		else
-			usermod "${opts[@]}" -c "${ecomment}" "${euser}" && return 0
-			[[ $? == 8 ]] && eerror "${euser} is in use, cannot update shell"
-			eerror "There was an error when attempting to update the shell for ${euser}"
-			eerror "Please update it manually on your system (as root):"
-			eerror "\t usermod -s \"${eshell}\" \"${euser}\""
-		fi
-		;;
-
 	*)
-		usermod "${opts[@]}" -c "${ecomment}" "${euser}" && return 0
+		usermod -c "${ecomment}" "${euser}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update comment"
 		eerror "There was an error when attempting to update the comment for ${euser}"
 		eerror "Please update it manually on your system (as root):"
@@ -645,9 +567,6 @@ esetgroups() {
 	elog "Updating groups for user '${euser}' ..."
 	elog " - Groups: ${egroups}"
 
-	# Handle different ROOT
-	[[ -n ${ROOT} ]] && opts+=( --prefix "${ROOT}" )
-
 	# update the group
 	case ${CHOST} in
 	*-freebsd*|*-dragonfly*)
@@ -658,19 +577,6 @@ esetgroups() {
 		eerror "\t pw usermod \"${euser}\" ${opts[*]}"
 		;;
 
-	*-netbsd*)
-		if [[ -n "${ROOT}" ]]; then
-			ewarn "NetBSD's usermod does not support --prefix <dir> option."
-			ewarn "Please use: \"usermod ${opts[@]} ${euser}\" in a chroot"
-		else
-			usermod "${opts[@]}" "${euser}" && return 0
-			[[ $? == 8 ]] && eerror "${euser} is in use, cannot update shell"
-			eerror "There was an error when attempting to update the shell for ${euser}"
-			eerror "Please update it manually on your system (as root):"
-			eerror "\t usermod -s \"${eshell}\" \"${euser}\""
-		fi
-		;;
-
 	*)
 		usermod "${opts[@]}" "${euser}" && return 0
 		[[ $? == 8 ]] && eerror "${euser} is in use, cannot update groups"
-- 
2.34.1

